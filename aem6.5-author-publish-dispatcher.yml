version: '3'
services:
    aem6.5-author:
        image: jmc22071983/aem6.5-author:0.0.1
        ports:
            - '4502:4502'
            - '8000:8000'
        environment:  
           RUNMODE: "${RUNMODE}"
        volumes:
            - 'aem6.5-author-volume:/crx-quickstart/logs'
        deploy:
            replicas: 1
            placement:
                constraints: 
                    - node.hostname == docker-desktop
        networks:
            - docker-aem
    aem6.5-publish:
        image: jmc22071983/aem6.5-publish:0.0.1
        ports:
            - '4503:4503'
            - '8001:8001'
        environment:  
           RUNMODE: "${RUNMODE}"
        volumes:
            - 'aem6.5-publish-volume:/crx-quickstart/logs'
        deploy:
            replicas: 1
            placement:
                constraints: 
                    - node.hostname == docker-desktop
        networks:
            - docker-aem
    apache-dispatcher:
        image: jmc22071983/dispatcher:0.0.1
        depends_on:
            - aem6.5-publish
        ports:
            - '80:80'
            - '443:443'
        environment:  
            AEM_HOST: 'aem6.5-publish'
            AEM_PORT: '4503'
        volumes:
            - 'aem-dispatcher-volume:/etc/httpd/dispatcher_cache'
            - 'aem-dispatcher-volume:/etc/httpd/logs'
        deploy:
            replicas: 1
            placement:
                constraints: 
                    - node.hostname == docker-desktop
        networks:
            - docker-aem 
volumes:
    aem6.5-author-volume:
    aem6.5-publish-volume:
    aem-dispatcher-volume:
networks:
    docker-aem:
        driver: overlay